#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2

BIN=$BUILD_DIR/bin

NODE_VERSION=v8.9.4
NODE_OS=linux
NODE_CPU=x64

# ex: linux-x64
NODE_PLATFORM=$NODE_OS-$NODE_CPU

# ex: node-linux-x64
NODE_DIST=node-$NODE_VERSION-$NODE_PLATFORM

#ex: node-linux-x64.tar.gz
NODE_TAR=$NODE_DIST.tar.gz

#ex: /tmp/heroku_cache_dir/node-linux-x64.tar.gz
NODE_TAR_PATH=$CACHE_DIR/$NODE_TAR

NODE_URL=https://s3.amazonaws.com/heroku-nodejs-bins/node/release/$NODE_PLATFORM/$NODE_TAR

mkdir -p $BIN

[ ! -d $CACHE_DIR ] && mkdir -p $CACHE_DIR

echo "Downloading node $NODE_VERSION..."
curl -sL $NODE_URL -o $NODE_TAR_PATH

if [ -f $NODE_TAR_PATH ]; then
  echo "Download complete, extracting downloaded content..."
  tar zxf $NODE_TAR_PATH

  echo "Installing node $NODE_VERSION"
  mkdir -p $BIN
  mv $NODE_DIST $BIN

  $BIN/$NODE_DIST/node -v

  exit 0
fi

exit 3003