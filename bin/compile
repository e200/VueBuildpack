#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

BUILD_DIR=$1
CACHE_DIR=$2

NODE_VERSION=v8.9.0
NODE_DIST=node-$NODE_VERSION-linux-x64
NODE_TAR=$NODE_DIST.tar.xz
NODE_TAR_PATH=$CACHE_DIR/$NODE_TAR
NODE_URL="https://nodejs.org/dist/$NODE_VERSION/$NODE_TAR"
NODE_BIN=$BUILD_DIR/bin

[ ! -f $CACHE_DIR ] && mkdir -p $CACHE_DIR

echo "Downloading node $NODE_VERSION..."
curl -sL $NODE_URL -o $NODE_TAR_PATH

if [ -f $NODE_TAR_PATH ]; then
  echo "Installing xz-utils..."
  su root
  dpkg -i http://http.us.debian.org/debian/pool/main/x/xz-utils/xz-utils_5.1.1alpha+20120614-2+b3_amd64.deb

  echo "Download complete, extracting downloaded content..."
  tar xf $NODE_TAR_PATH

  echo "Installing node $NODE_VERSION"
  mkdir -p $NODE_BIN
  mv $NODE_DIST $NODE_BIN

  $NODE_BIN/$NODE_DIST/node -v

  exit 0
fi

exit 3003