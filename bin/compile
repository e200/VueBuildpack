#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

build_dir=$1
cache_dir=$2

build_bin=$build_dir/bin

node_version=v8.9.4
node_os=linux
node_cpu=x64

# ex: linux-x64
node_platform=$node_os-$node_cpu

# ex: node-linux-x64
node_dist=node-$node_version-$node_platform

#ex: node-linux-x64.tar.gz
node_tar=$node_dist.tar.gz

#ex: /tmp/heroku_cache_dir/node-linux-x64.tar.gz
node_tar_PATH=$cache_dir/$node_tar

node_url=https://s3.amazonaws.com/heroku-nodejs-bins/node/release/$node_platform/$node_tar

[ ! -d $cache_dir ] && mkdir -p $cache_dir

if [ -f $node_tar_PATH ]; then
  echo "Using cached $node_tar"
else
  echo "Downloading node $node_version..."
  curl -sL $node_url -o $node_tar_PATH
fi

if [ -f $node_tar_PATH ]; then
  echo "Installing node $node_version"
  tar zxf $node_tar_PATH
  mkdir -p $build_bin
  mv $node_dist $build_bin
  chmod -R +x $build_bin/$node_dist/*

  $build_bin/$node_dist/bin/node -v

  exit 0
fi

exit 3003